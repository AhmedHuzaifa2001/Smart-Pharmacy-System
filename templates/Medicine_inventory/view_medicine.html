{% extends 'base.html' %}

{% block title %}Medicine List{% endblock title %}

{% block content %}
<!-- Tailwind CSS and Custom Styles -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
        }
        .navbar {
            background-color: #1a202c; /* Dark gray for navbar */
            color: #ffffff;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .navbar a {
            color: #ffffff;
            margin-right: 1.5rem;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease-in-out;
        }
        .navbar a:hover {
            color: #a0aec0; /* Lighter gray on hover */
        }
        .btn-primary {
            background-color: #4299e1; /* Blue */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #3182ce; /* Darker blue */
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Darker red */
        }
        .form-control {
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
            box-sizing: border-box; /* Ensures padding doesn't increase width */
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .messages {
            list-style: none;
            padding: 0;
            margin-bottom: 1rem;
        }
        .messages li {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .messages .success {
            background-color: #d1fae5; /* Green light */
            color: #065f46; /* Green dark */
            border: 1px solid #34d399;
        }
        .messages .error {
            background-color: #fee2e2; /* Red light */
            color: #991b1b; /* Red dark */
            border: 1px solid #ef4444;
        }
        .messages .warning {
            background-color: #fffbeb; /* Yellow light */
            color: #92400e; /* Yellow dark */
            border: 1px solid #f59e0b;
        }
        .messages .info {
            background-color: #e0f2fe; /* Blue light */
            color: #1e40af; /* Blue dark */
            border: 1px solid #60a5fa;
        }
        .table-auto {
            width: 100%;
            border-collapse: collapse;
        }
        .table-auto th, .table-auto td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        .table-auto th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        .table-auto tbody tr:nth-child(odd) {
            background-color: #f3f4f6;
        }
        .table-auto tbody tr:hover {
            background-color: #e5e7eb;
        }
.popover {
    max-width: 800px;
    width: 800px;
  }

</style>

<div class="container mx-auto px-4 py-8">
  <h2 class="text-center text-3xl font-bold mb-6">Medicine Inventory</h2>

  <!-- Top Action Buttons -->
  <div class="flex flex-wrap justify-between items-center mb-6">
    <div class="mb-2 space-x-2">
      <a href="{% url 'medicine_table' %}" class="btn-primary inline-block">View as Table</a>
      <a href="{% url 'med_inventory_dash' %}" class="btn-primary inline-block">Go to Dashboard</a>
      <a href="{% url 'export_medicine_csv' %}" class="btn-primary bg-green-500 hover:bg-green-600 inline-block">Export CSV</a>
      <a href="{% url 'export_medicine_pdf' %}" class="btn-danger inline-block">Export PDF</a>
    </div>
    <div class="mb-2">
      <a href="{% url 'medicine_create' %}" class="btn-primary inline-block">Add New Medicine</a>
    </div>
  </div>

  <div class="text-left my-4">
  <button type="button"
          class="btn btn-outline-danger"
          data-bs-toggle="popover"
          data-bs-html="true"
          data-bs-trigger="hover focus"
          title="Recently Performed Actions"
          data-bs-content='
            <ul class="list-group list-group-flush text-start">
              {% for action in recent_actions %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <strong>
                      {% if action.medicine %}
                        {{ action.medicine.name }} ({{ action.medicine.batch_number }})
                      {% else %}
                        {{ action.medicine_name }} ({{ action.batch_number }})
                      {% endif %}
                    </strong>
                    <span class="badge bg-warning ms-2">{{ action.get_action_display }}</span>
                  </span>
                  <small class="text-muted">{{ action.timestamp|date:"M d, Y H:i" }}</small>
                </li>
              {% empty %}
                <li class="list-group-item text-muted text-center">No recent actions.</li>
              {% endfor %}
            </ul>
          '>
    Hover to see Recent Actions
  </button>
</div>

  <!-- Filter Section -->
  <div class="bg-white shadow rounded-lg p-6 mb-8">
    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label for="category" class="block font-medium text-gray-700 mb-1">Category</label>
        <select name="category" id="category" class="form-control">
          <option value="">All</option>
          {% for cat in categories %}
            <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="expiry" class="block font-medium text-gray-700 mb-1">Expiry Status</label>
        <select name="expiry" id="expiry" class="form-control">
          <option value="">All</option>
          <option value="near" {% if request.GET.expiry == 'near' %}selected{% endif %}>Near Expiry</option>
          <option value="expired" {% if request.GET.expiry == 'expired' %}selected{% endif %}>Expired</option>
        </select>
      </div>
      <div>
        <label for="low_stock" class="block font-medium text-gray-700 mb-1">Stock Status</label>
        <select name="low_stock" id="low_stock" class="form-control">
          <option value="">All</option>
          <option value="low" {% if request.GET.low_stock == 'low' %}selected{% endif %}>Low Stock</option>
        </select>
      </div>
      <div class="flex items-end">
        <button type="submit" class="btn-primary w-full">Filter</button>
      </div>
    </form>
  </div>

  <!-- Medicine Cards Grid -->
  <div class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
    {% if medicine %}
      {% for med in medicine %}
        <div class="bg-white rounded-lg shadow border-2 flex flex-col h-full">
          <div class="flex justify-between items-center p-4 border-b">
            <strong>{{ med.name }}</strong>
            <div class="space-x-2">
              {% if med.is_expired %}
                <span class="text-xs font-semibold text-white bg-red-500 px-2 py-1 rounded">Expired</span>
              {% elif med.near_expiry %}
                <span class="text-xs font-semibold text-white bg-red-400 px-2 py-1 rounded">Near Expiry</span>
              {% endif %}
              {% if med.low_stock %}
                <span class="text-xs font-semibold text-white bg-gray-700 px-2 py-1 rounded">Low Stock</span>
              {% endif %}
            </div>
          </div>
          <div class="p-4 text-sm text-gray-700 space-y-1">
            <p><strong>Batch:</strong> {{ med.batch_number }}</p>
            <p><strong>Brand:</strong> {{ med.brand }}</p>
            <p><strong>Category:</strong> {{ med.category }}</p>
            <p><strong>Dosage:</strong> {{ med.dosage }}</p>
            <p><strong>Quantity:</strong> {{ med.quantity_in_stock }}</p>
          </div>
          <div class="p-4 mt-auto border-t flex justify-between items-center">
            <a href="{% url 'medicine_update' med.id %}" class="btn-primary text-sm px-4 py-2">Edit</a>
            <button type="button"
                    class="btn-danger text-sm px-4 py-2"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteModal{{ med.id }}">
              Delete
            </button>
          </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal fade" id="deleteModal{{ med.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ med.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete <strong>{{ med.name }} - {{ med.batch_number }}</strong>?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn-primary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'medicine_delete' med.id %}" class="btn-danger">Delete</a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="col-span-3">
        <div class="messages">
          <li class="info text-center">No medicines found.</li>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    popoverTriggerList.forEach(function (popoverTriggerEl) {
      new bootstrap.Popover(popoverTriggerEl)
    })
  });
</script>
{% endblock content %}