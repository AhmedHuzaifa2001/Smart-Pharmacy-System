{% extends "onlineStore/onlineStore_base.html" %}
{% load static %}
{% block title %}{% if form.instance.pk %}Edit Prescription{% else %}Upload Prescription{% endif %} - MediSync{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen pt-40 pb-16">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-white/50 p-8">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
          {% if form.instance.pk %}Edit Prescription{% else %}Upload Prescription{% endif %}
        </h1>
        <p class="text-gray-600 mt-2">
          {% if form.instance.pk %}
            Update your prescription details and image.
          {% else %}
            Upload your prescription for pharmacist review.
          {% endif %}
        </p>
      </div>

      <!-- Messages -->
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for message in messages %}
            <div class="px-4 py-3 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
              <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                {{ message }}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Form -->
      <form method="post" enctype="multipart/form-data" novalidate class="space-y-6">
        {% csrf_token %}
        
        <!-- Non-field errors -->
        {% if form.non_field_errors %}
          <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <!-- Prescription Image -->
        <div class="space-y-2">
          <label for="{{ form.prescription_image.id_for_label }}" class="block text-sm font-medium text-gray-900">
            Prescription Image <span class="text-red-500">*</span>
          </label>
          
          <!-- Custom file upload area -->
          <div class="relative">
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-indigo-500 transition-colors cursor-pointer bg-gray-50/50">
              <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <div class="mt-4">
                <label for="{{ form.prescription_image.id_for_label }}" class="cursor-pointer">
                  <span class="mt-2 block text-sm font-medium text-indigo-600 hover:text-indigo-500">
                    Click to upload
                  </span>
                  <span class="mt-1 block text-xs text-gray-500">
                    or drag and drop
                  </span>
                </label>
                <p class="mt-1 text-xs text-gray-500">PNG, JPG up to 5MB</p>
              </div>
              {{ form.prescription_image }}
            </div>
          </div>

          {% if form.prescription_image.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.prescription_image.errors|striptags }}</p>
          {% endif %}

          <!-- Image Preview -->
          <div id="previewContainer" class="mt-4 {% if not form.instance.prescription_image %}hidden{% endif %}">
            <div class="relative inline-block">
              <img id="preview" 
                   src="{% if form.instance.prescription_image %}{{ form.instance.prescription_image.url }}{% endif %}" 
                   alt="Preview" 
                   class="max-w-full h-auto rounded-xl border-2 border-gray-200 shadow-lg"
                   style="max-height: 400px;">
              <button type="button" id="removeImage" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 transition-colors shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- NIC Field -->
        <div class="space-y-2">
          <label for="{{ form.nic.id_for_label }}" class="block text-sm font-medium text-gray-900">
            National Identity Card (NIC) <span class="text-red-500">*</span>
          </label>
          <input type="text" 
                 name="nic" 
                 id="{{ form.nic.id_for_label }}"
                 value="{{ form.nic.value|default:'' }}"
                 class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                 placeholder="e.g., 199012345678 or 901234567V">
          {% if form.nic.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.nic.errors|striptags }}</p>
          {% endif %}
          <p class="text-xs text-gray-500 mt-1">Enter 12 digits or 9 digits + V/X</p>
        </div>

        <!-- Notes Field -->
        <div class="space-y-2">
          <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-900">
            Notes (Optional)
          </label>
          <textarea name="notes" 
                    id="{{ form.notes.id_for_label }}"
                    rows="4"
                    class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                    placeholder="Add any additional information or special instructions...">{{ form.notes.value|default:'' }}</textarea>
          {% if form.notes.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.notes.errors|striptags }}</p>
          {% endif %}
        </div>

        <!-- Order Field -->
        <div class="space-y-2">
          <label for="{{ form.order.id_for_label }}" class="block text-sm font-medium text-gray-900">
            Attach to Order (Optional)
          </label>
          <select name="order" 
                  id="{{ form.order.id_for_label }}"
                  class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
            <option value="">Select an order (optional)</option>
            {% for choice in form.order.field.choices %}
              {% if choice.0 %}
                <option value="{{ choice.0 }}" {% if form.order.value == choice.0 %}selected{% endif %}>
                  {{ choice.1 }}
                </option>
              {% endif %}
            {% endfor %}
          </select>
          {% if form.order.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.order.errors|striptags }}</p>
          {% endif %}
          <p class="text-xs text-gray-500 mt-1">Only your orders without a prescription are shown</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 pt-6 border-t border-gray-200">
          <button type="submit" 
                  class="flex-1 sm:flex-none inline-flex justify-center items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors shadow-md">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            {% if form.instance.pk %}Update Prescription{% else %}Submit Prescription{% endif %}
          </button>
          <a href="/MediSync/" 
             class="flex-1 sm:flex-none inline-flex justify-center items-center px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Instructions Modal -->
<div id="instructionsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <!-- Background overlay -->
  <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true"></div>

  <!-- Modal panel - Centered -->
  <div class="relative bg-white rounded-2xl shadow-2xl transform transition-all w-full max-w-lg my-8">
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-5 rounded-t-2xl">
      <div class="flex items-center">
        <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-white/20">
          <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="ml-3 text-xl font-semibold text-white" id="modal-title">
          Prescription Upload Instructions
        </h3>
      </div>
    </div>
    
    <div class="bg-white px-6 py-5">
      <div class="space-y-4">
        <div class="flex items-start">
          <div class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full bg-indigo-100 text-indigo-600 font-semibold">
            1
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-900">Valid Prescription Required</p>
            <p class="mt-1 text-sm text-gray-600">Only valid prescriptions from a registered doctor are accepted.</p>
          </div>
        </div>

        <div class="flex items-start">
          <div class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full bg-indigo-100 text-indigo-600 font-semibold">
            2
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-900">Clear Image Quality</p>
            <p class="mt-1 text-sm text-gray-600">Upload a clear image — blurry or cropped files may be rejected.</p>
          </div>
        </div>

        <div class="flex items-start">
          <div class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full bg-indigo-100 text-indigo-600 font-semibold">
            3
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-900">Verification Notification</p>
            <p class="mt-1 text-sm text-gray-600">You'll be notified once your prescription is verified.</p>
          </div>
        </div>
      </div>

      <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex">
          <svg class="h-5 w-5 text-yellow-400 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <div>
            <p class="text-sm font-medium text-yellow-800">Important</p>
            <p class="text-xs text-yellow-700 mt-1">Please ensure all text on the prescription is clearly visible and readable before uploading.</p>
            <p class="mt-6 text-sm text-gray-500">
              <strong>Disclaimer:</strong> By submitting this prescription, you confirm that all medicines listed are prescribed by a licensed medical practitioner and comply with applicable pharmaceutical laws and regulations. The pharmacy reserves the right to verify the authenticity of the prescription and may decline to process any order that does not meet legal or professional standards.
            </p>
          </div>
        </div>
      </div>

      <!-- Checkbox -->
      <div class="mt-6">
        <label class="flex items-start cursor-pointer group">
          <input type="checkbox" id="agreeCheckbox" class="mt-1 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
          <span class="ml-3 text-sm text-gray-700 group-hover:text-gray-900">
            I have read and understood the prescription upload instructions
            
          </span>
        </label>
      </div>
    </div>

    <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
      <a href="/MediSync/" 
         class="w-full sm:w-auto inline-flex justify-center items-center rounded-lg border border-gray-300 shadow-sm px-6 py-3 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-all duration-200">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Go Back
      </a>
      <button type="button" 
              id="proceedButton"
              disabled
              class="w-full sm:w-auto inline-flex justify-center items-center rounded-lg border border-transparent shadow-sm px-6 py-3 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:hover:bg-gray-300">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Continue to Upload
      </button>
    </div>
  </div>
</div>

<style>
  #{{ form.prescription_image.id_for_label }} {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    cursor: pointer;
  }

  /* Modal centering and animation */
  #instructionsModal {
    display: none;
  }

  #instructionsModal.show {
    display: flex !important;
    animation: fadeIn 0.2s ease-out;
  }

  #instructionsModal.show > div:last-child {
    animation: slideUp 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('instructionsModal');
    const agreeCheckbox = document.getElementById('agreeCheckbox');
    const proceedButton = document.getElementById('proceedButton');
    const fileInput = document.querySelector('input[type="file"][name$="prescription_image"]');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('previewContainer');
    const removeBtn = document.getElementById('removeImage');
    const dropZone = document.getElementById('dropZone');

    // Show modal on page load every time (only for new uploads, not edits)
    {% if not form.instance.pk %}
    setTimeout(function() {
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }, 300);
    {% endif %}

    // Enable/disable proceed button based on checkbox
    if (agreeCheckbox) {
        agreeCheckbox.addEventListener('change', function() {
            proceedButton.disabled = !this.checked;
            if (this.checked) {
                proceedButton.classList.remove('disabled:bg-gray-300');
                proceedButton.classList.add('bg-indigo-600');
            } else {
                proceedButton.classList.add('disabled:bg-gray-300');
                proceedButton.classList.remove('bg-indigo-600');
            }
        });
    }

    // Close modal
    if (proceedButton) {
        proceedButton.addEventListener('click', function() {
            modal.classList.add('hidden');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        });
    }

    if (!fileInput) return;

    fileInput.setAttribute('accept', 'image/*');

    // File input change
    fileInput.addEventListener('change', function (e) {
        handleFile(e.target.files[0]);
    });

    // Drag and drop
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            handleFile(file);
        }
    });

    // Remove image
    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            preview.src = '';
            previewContainer.classList.add('hidden');
            fileInput.value = '';
        });
    }

    function handleFile(file) {
        if (!file) {
            previewContainer.classList.add('hidden');
            preview.src = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function (ev) {
            preview.src = ev.target.result;
            previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    // Prevent accidental modal close by clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            e.preventDefault();
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
            // Only close if checkbox is checked (instructions read)
            if (agreeCheckbox && agreeCheckbox.checked) {
                modal.classList.add('hidden');
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }
    });
});
</script>
{% endblock %}