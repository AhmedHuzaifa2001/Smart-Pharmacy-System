{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Prescription #{{ prescription.id }}</h2>
        <a href="{% url 'onlinePrescription:list' %}" class="btn btn-outline-secondary">Back to list</a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-md-5">
            {% if prescription.prescription_image %}
                <div class="card">
                    <img src="{{ prescription.prescription_image.url }}" class="card-img-top" alt="Prescription image" style="max-height:500px; object-fit:contain;">
                    <div class="card-body">
                        <p class="mb-0"><strong>Uploaded:</strong> {{ prescription.uploaded_at|date:"SHORT_DATETIME_FORMAT" }}</p>
                        <p class="mb-0"><strong>Uploaded by:</strong> {{ prescription.user.username }}</p>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-warning">No image available.</div>
            {% endif %}
        </div>

        <div class="col-md-7">
            <table class="table table-borderless">
                <tr>
                    <th>NIC</th>
                    <td>{{ prescription.nic }}</td>
                </tr>
                <tr>
                    <th>Status</th>
                    <td>
                        <span class="badge 
                            {% if prescription.status == 'Pending' %}bg-secondary
                            {% elif prescription.status == 'Reviewed' %}bg-info
                            {% elif prescription.status == 'Approved' %}bg-success
                            {% elif prescription.status == 'Rejected' %}bg-danger
                            {% else %}bg-light text-dark{% endif %}">
                            {{ prescription.status }}
                        </span>
                    </td>
                </tr>
                <tr>
                    <th>Notes</th>
                    <td>{% if prescription.notes %}{{ prescription.notes|linebreaksbr }}{% else %}<em>—</em>{% endif %}</td>
                </tr>
                <tr>
                    <th>Pharmacist comment</th>
                    <td>{% if prescription.pharmacist_comment %}{{ prescription.pharmacist_comment|linebreaksbr }}{% else %}<em>—</em>{% endif %}</td>
                </tr>
                <tr>
                    <th>Order</th>
                    <td>
                        {% if prescription.order %}
                            Order #{{ prescription.order.order_id }}
                            {% if request.user.is_staff %}
                                &middot; <a href="/admin/{{ prescription.order._meta.app_label }}/{{ prescription.order._meta.model_name }}/{{ prescription.order.pk }}/change/">Open in admin</a>
                            {% endif %}
                        {% else %}
                            <em>Not attached</em>
                        {% endif %}
                    </td>
                </tr>
            </table>

            <div class="mt-3">
                {% if request.user.is_authenticated and request.user == prescription.user %}
                    <a href="{% url 'onlinePrescription:edit' prescription.pk %}" class="btn btn-primary">Edit</a>
                    <a href="{% url 'onlinePrescription:delete' prescription.pk %}" class="btn btn-danger ms-2">Delete</a>
                {% endif %}

                {% if request.user.is_authenticated and request.user.role|default:'' == 'pharmacist' %}
                    <a href="{% url 'onlinePrescription:pharmacist_review' prescription.pk %}" class="btn btn-outline-success">Review / Update</a>
                    <a href="{% url 'onlinePrescription:pharmacist_list' %}" class="btn btn-outline-secondary ms-2">Pharmacist list</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}